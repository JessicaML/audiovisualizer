<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AudioVisualizer</title>
    <link rel="stylesheet" href="src/styles/index.css" type="text/css" />
  </head>
  <body>
    <div id="content">
      <input type="file" id="thefile" accept="audio/*" />
      <canvas id="canvas"></canvas>
      <audio id="audio" capture></audio>
    </div>
  </body>
  <script>
    const hello = () => console.log("hello");
    hello();
  </script>
  <script>
    window.onload = function() {
      const audio = document.getElementById("audio");

      const visualize = function() {
        console.log('Visualize!')
        var context = new AudioContext();
        // var src = context.createMediaElementSource(audio);
        var analyser = context.createAnalyser();

        var canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        var ctx = canvas.getContext("2d");

        // src.connect(analyser);
        analyser.connect(context.destination);

        analyser.fftSize = 256;

        var bufferLength = analyser.frequencyBinCount;
        console.log(bufferLength);

        var dataArray = new Uint8Array(bufferLength);

        var WIDTH = canvas.width;
        var HEIGHT = canvas.height;

        var barWidth = (WIDTH / bufferLength) * 2.5;
        var barHeight;
        var x = 0;

        function renderFrame() {
          requestAnimationFrame(renderFrame);

          x = 0;

          analyser.getByteFrequencyData(dataArray);

          ctx.fillStyle = "#000";
          ctx.fillRect(0, 0, WIDTH, HEIGHT);

          for (var i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i];

            var r = barHeight + 25 * (i / bufferLength);
            var g = 250 * (i / bufferLength);
            var b = 255;
            ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
            ctx.fillRect(x, barHeight, barWidth, HEIGHT + barHeight);
            x += barWidth + 1;
          }
        }
        renderFrame();
      };

      const handleSuccess = function(stream) {
        console.log('mic listening!')
        if (window.URL) {
          audio.srcObject = stream;
        } else {
          audio.src = stream;
        }

        visualize();
      };

      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then(handleSuccess);
    };
  </script>
  <script src="src/javascript/hello.js" type="javascript"></script>
  <script src="src/javascript/audioanalyzer.js" type="javascript"></script>
</html>
